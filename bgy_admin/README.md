# BYG Admin Backend Management System

## 项目简介

BYG Admin 是一个基于 Django + DRF 的现代化后台管理系统，提供了完善的权限管理、用户认证、日志追踪等功能。

## 技术栈

- Python 3.8+
- Django 4.2+
- Django REST Framework (DRF)
- DRF Simple JWT (认证)
- MySQL 8.0+ (数据库)
- Redis (缓存&会话管理)
- Loguru (日志管理)

## 核心功能

1. 用户管理

   - 用户注册、登录、登出
   - 密码重置
   - 用户信息管理
   - 用户角色管理

2. 权限管理

   - 基于 RBAC 的权限控制
   - 角色管理
   - 权限分配
   - 菜单权限

3. 系统管理

   - 系统配置
   - 菜单管理
   - 操作日志
   - 登录日志

4. 数据监控
   - 在线用户监控
   - 系统性能监控
   - API 访问统计

## 项目结构

## 开发日志

### 2024-01-08

#### 1. 配置自定义用户模型

- 在 settings 中指定 AUTH_USER_MODEL 为 users.User
- 配置认证后端为 ModelBackend

#### 2. 日志系统升级

- 使用 loguru 替代 Django 默认日志系统
- 实现按日期自动创建日志目录
- 分别记录 Django 应用日志、数据库日志和错误日志
- 支持日志文件自动轮转和保留策略

#### 3. 模拟数据生成

- 创建 generate_mock_data.py 脚本
- 使用 Faker 库生成中文测试数据
- 生成部门、角色、用户等基础数据
- 导出为 SQL 文件方便导入

#### 4. API 响应格式统一

- 创建 APIResponse 类统一响应格式
- 统一返回 code、message、data 三个字段
- 支持额外参数扩展

#### 5. 全局异常处理

- 实现 custom_exception_handler 统一处理异常
- 处理常见异常如 404、权限不足等
- 集成日志记录
- 统一异常响应格式

#### 6. 数据库配置修复

- 修复了 MySQL 数据库配置问题
- 添加了字符集和 SQL 模式配置
- 确保数据库连接的稳定性

#### 7. 模拟数据生成增强

- 完善了数据生成脚本，支持所有模型
- 添加了菜单、权限、配置等数据生成
- 生成更真实的中文测试数据
- 支持批量数据导入
- 添加了详细的 SQL 注释

#### 8. 代码优化

- 规范了代码格式和导入顺序
- 优化了异常处理和日志记录
- 完善了文档注释

#### 9. API 文档系统

- 集成 drf-spectacular 自动生成 API 文档
- 添加了 Swagger UI 和 ReDoc 两种文档界面
- 为所有 API 添加了详细的参数说明
- 支持在线调试 API
- 完善了认证和权限相关的文档说明

#### 10. 认证系统优化

- 重写了 JWT Token 获取和刷新接口
- 统一了认证接口的返回格式
- 添加了令牌过期时间等信息
- 完善了认证接口的文档说明

#### 11. API 文档增强

- 添加了 YAML 格式的 API 文档生成
- 支持导出完整的 API 接口说明
- 包含了请求参数、响应格式等详细信息
- 便于前端开发人员集成和使用

#### 12. API 文档生成优化

- 修复了文档生成脚本的环境配置问题
- 优化了 API 文档的结构和分类
- 完善了认证接口的响应示例
- 添加了更多的接口说明和使用示例

#### 13. API Schema 生成修复

- 修复了 Schema 生成时的序列化器问题
- 添加了自定义的 Schema 处理钩子
- 优化了响应格式的文档展示
- 统一了 API 文档的响应格式定义

#### 14. API 文档结构优化

- 创建了专门的 API 文档目录结构
- 将每个接口文档单独存放
- 添加了详细的接口说明和示例
- 统一了文档格式和风格
- 提供了完整的请求响应示例

#### 15. 用户管理接口文档

- 完善了用户管理相关的所有接口文档：
  - 获取用户列表
  - 获取用户详情
  - 创建用户
  - 更新用户
  - 删除用户
  - 重置用户密码
  - 修改个人信
  - 上传用户头像
- 统一了接口文档的格式和风格
- 添加了详细的请求和响应示例
- 完善了权限要求说明
- 规范了参数表格的对齐和间距
- 修复了文档中的编码问题

#### 16. 用户认证功能实现

- 实现了完整的用户认证功能：
  - 用户登录（支持用户名密码登录）
  - Token 获取和刷新
  - 用户登出（支持使 refresh_token 失效）
  - Session 登录支持（可选记住登录状态）
- 修复了认证相关的问题：
  - 修复了登录接口的权限控制
  - 优化了 Token 验证异常处理
  - 统一了错误响应格式
  - 完善了异常日志记录
- 完善了认证相关的序列化器：
  - CustomTokenObtainPairSerializer（Token 获取）
  - CustomTokenRefreshSerializer（Token 刷新）
  - LoginSerializer（登录信息验证）
  - LogoutSerializer（登出请求处理）
- 实现了认证相关的视图：
  - AuthViewSet（处理登录登出）
  - CustomTokenObtainPairView（获取 Token）
  - CustomTokenRefreshView（刷新 Token）
- 添加了详细的代码注释和文档字符串
- 优化了认证相关的配置：
  - JWT 配置（有效期、刷新机制等）
  - 认证后端配置
  - Session 配置

#### 17. 用户管理功能实现

- 实现了用户管理相关功能：
  - 用户列表（支持 页、搜索、过滤、排序）
  - 用户详情
  - 创建用户（包含密码验证）
  - 更新用户
  - 删除用户
  - 修改密码
  - 上传头像
  - 批量删除
  - 批量启用/禁用
- 完善了用户相关的序列化器：
  - UserListSerializer（列表展示）
  - UserDetailSerializer（详情展示）
  - UserCreateSerializer（创建用户）
  - UserUpdateSerializer（更新用户）
  - ChangePasswordSerializer（修改密码）
- 实现了用户管理视图集：
  - 基于 ModelViewSet 的完整 CRUD 操作
  - 自定义的批量操作接口
  - 文件上传处理
  - 详细的参数验证
- 添加了完整的过滤和搜索：
  - 支持多字段搜索
  - 支持字段过滤
  - 支持日期范围过滤
  - 支持多字段排序
- 优化了用户模型：
  - 添加了更多用户属性
  - 完善了字段验证
  - 添加了详细的文档说明

### 下一步计划

1. 实现角色管理相关 API
2. 完善角色管理接口文档
3. 完善部门管理接口文档
4. 完善权限管理接口文档
5. 完善菜单管理接口文档
6. 完善系统配置接口文档
7. 完善系统监控接口文档
8. 完善用户管理功能
   - 用户导入导出
   - 用户数据统计
   - 在线用户管理
   - 登录日志记录

### 2024-01-09 更新

1. 用户管理模块扩展功能

   - 实现用户导入导出功能

     - 支持导出用户数据为 Excel 文件
     - 支持从 Excel 文件导入用户数据
     - 支持批量创建和更新用户

   - 实现用户数据统计功能

     - 提供用户总数、活跃用户等概览数据
     - 支持角色分布、部门分布统计
     - 支持性别分布统计
     - 提供近 30 天新增用户趋势

   - 实现在线用户管理功能

     - 查看当前在线用户列表
     - 支持强制用户下线
     - 自动清理过期会话

   - 实现登录日志记录功能
     - 记录用户登录的详细信息
     - 支持多种登录方式记录
     - 提供日志查询和筛选功能

2. 数据模型更新
   - 新增 UserSession 模型，用于记录用户会话
   - 新增 LoginLog 模型，用于记录登录日志
3. 接口文档更新
   - 添加用户导入导出接口文档
   - 添加用户数据统计接口文档
   - 添加在线用户管理接口文档
   - 添加登录日志查询接口文档

### 2024-01-10 更新 (补充)

1. 部门管理模块扩展功能

   - 实现部门导入导出功能

     - 支持导出部门数据为 Excel 文件
     - 支持从 Excel 文件导入部门数据
     - 支持批量创建和更新部门
     - 自动处理部门层级关系

   - 实现部门数据统计功能
     - 提供部门总数、活跃部门数等概览数据
     - 支持部门层级分布统计
     - 展示人员最多的前 5 个部门
     - 提供近 30 天新增部门趋势

2. API 文档更新
   - 添加部门导入导出接口文档
   - 添加部门统计接口文档
   - 完善部门管理相关接口说明

## 待办事项

1. 用户管理模块

   - [ ] 实现用户行为日志记录
   - [ ] 添加用户操作审计功能
   - [ ] 实现用户数据导出的定时任务
   - [ ] 优化用户导入的性能

2. 系统功能

   - [ ] 实现系统监控功能
   - [ ] 添加定时任务管理
   - [ ] 实现数据库备份功能
   - [ ] 添加系统通知功能

3. 文档完善
   - [ ] 补充项目部署文档
   - [ ] 添加开发环境搭建指南
   - [ ] 完善接口调用示例
   - [ ] 添加常见问题解答

# 部门管理系统接口文档

## 文档说明

本文档详细描述了部门管理系统的所有接口,包括接口说明、请求参数、响应数据等内容。

## 文档目录

### 1. 部门基础管理

- [部门增删改查](docs/api/departments/crud.md)
- [部门树形结构](docs/api/departments/tree.md)
- [部门用户管理](docs/api/departments/users.md)
- [部门统计数据](docs/api/departments/statistics.md)

### 2. 部门数据管理

- [部门导入导出](docs/api/departments/import_export.md)
- [部门数据权限](docs/api/departments/data_permissions.md)
- [部门角色管理](docs/api/departments/roles.md)

### 3. 部门审计管理

- [部门审计报告](docs/api/departments/audit.md)
- [部门日志查询](docs/api/departments/logs.md)

## 最近更新

1. 新增部门数据管理文档:

   - 导入导出功能
   - 数据权限配置
   - 角色管理接口

2. 新增部门审计功能文档:

   - 审计报告生成
   - 操作日志查询
   - 数据统计分析

3. 新增角色管理功能文档:

   - 创建 RoleViewSet 视图集
   - 实现角色的增删改查接口
   - 添加角色权限控制
   - 支持按名称和状态过滤

4. 更新接口文档

   - 添加角色管理接口文档
   - 规范化接口响应格式
   - 完善参数说明和示例
   - 添加中文注释和说明

5. 优化项目结构

   - 重构权限控制逻辑
   - 优化数据过滤实现
   - 完善异常处理
   - 添加接口测试用例

6. 新增角色分配功能

   - 实现角色分配用户接口
   - 实现角色分配部门接口
   - 添加相关接口文档
   - 完善 Swagger 配置

7. 新增用户分配功能
   - 实现用户分配角色接口
   - 实现用户分配部门接口
   - 添加相关接口文档
   - 完善 Swagger 配置

## 注意事项

1. 接口认证

   - 所有接口都需要在请求头中携带 token
   - token 格式: `Authorization: Bearer <access_token>`
   - token 过期需要重新登录获取

2. 数据权限

   - 接口访问需要相应的权限
   - 数据过滤基于用户权限
   - 某些操作可能需要更高权限

3. 性能优化
   - 使用缓存减少查询
   - 大量数据操作使用异步任务
   - 合理使用数据过滤

## 联系我们

如有问题请联系:

- 技术支持: support@example.com
- 文档维护: docs@example.com
